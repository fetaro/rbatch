<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>
  File: README.ja
  
    &mdash; Documentation by YARD 0.8.7.3
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README.ja</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><div id='filecontents'><p><a href="https://github.com/fetaro/rbatch/blob/master/README.md" title="english">English</a> | <a href="https://github.com/fetaro/rbatch/blob/master/README.ja.md" title="japanese">Japanese </a> |  <a href="http://fetaro.github.io/rbatch/index.html">Document (YardDoc)</a></p>

<p><a href="http://badge.fury.io/rb/rbatch"><img src="https://badge.fury.io/rb/rbatch.svg" alt="Gem Version"></a>
<a href="https://travis-ci.org/fetaro/rbatch"><img src="https://travis-ci.org/fetaro/rbatch.svg?branch=master" alt="Build Status"></a></p>

<h1>RBatch: バッチスクリプト フレームワーク</h1>

<h2>RBatchについて</h2>

<p>RBatchはRubyで書かれたシンプルなバッチスクリプト(運用スクリプト)のフレームワークです。
バッチスクリプト（バックアップやプロセスリロード等）を書く際に便利な機能をフレームワークとして提供しています。</p>

<p>主な機能は以下のとおり。</p>

<ul>
<li>自動ログ出力</li>
<li>自動ライブラリ読み込み</li>
<li>自動メール送信</li>
<li>自動設定ファイル読み込み</li>
<li>外部コマンド実行</li>
<li>二重起動チェック</li>
</ul>

<p>注意：このフレームワークはRuby 1.9で動作します。</p>

<p>このソフトウェアは、MITライセンスのもとで公開しています。LICENSE.txtを見てください。</p>

<h2>クイックスタート</h2>

<pre class="code ruby"><code class="ruby">$ sudo gem install rbatch
$ rbatch-init    # =&gt; ディレクトリとサンプルスクリプトが作られます
$ ruby bin/hello_world.rb
$ cat log/YYYYMMDD_HHMMSS_hello_world.log
</code></pre>

<h2>機能概要</h2>

<h3>RBatchホームディレクトリ</h3>

<p>環境変数<code>${RB_HOME}</code>を定義する事で、その場所をRBatchのホームディレクトリに固定することができます。</p>

<p>環境変数<code>${RB_HOME}</code>を定義していない場合は、「実行するスクリプトが配置されているディレクトリの親ディレクトリ」が$RB_HOMEになります。言い換えると<code>${RB_HOME}</code>のデフォルト値は<code>(スクリプトのパス)/../</code>です。</p>

<h3>ディレクトリ構成と命名規則</h3>

<p>&quot;設定より規約&quot;の原則に基づいて、
RBatchでは、実行スクリプト、設定ファイルおよびログファイルについて、
配置場所および命名規則が規約で決めています。
ルールに従えば、ほとんど設定せずに、スクリプト開発に十分な環境が整います。</p>

<p>ルールは以下の通り</p>

<ul>
<li>仮に<code>${RB_HOME}/bin/hoge.rb</code>というスクリプトを作った場合</li>
<li>個別設定ファイルは<code>${RB_HOME}/conf/hoge.yaml</code>としてください。</li>
<li>共通設定ファイルは<code>${RB_HOME}/conf/common.yaml</code>としてください。</li>
<li>ライブラリは<code>${RB_HOME}/lib/*.rb</code>としてください。</li>
</ul>

<p>すると</p>

<ul>
<li><code>${RB_HOME}/log/YYYYMMDD_HHMMSS_hoge.rb</code>にログが出ます。</li>
</ul>

<p>例を示すと以下の通りです。</p>

<pre class="code ruby"><code class="ruby">${RB_HOME}         ←RBatchホームディレクトリ
 |
 |-.rbatchrc       ←Run-Conf
 |
 |-bin             ←実行スクリプト配置場所
 |  |- A.rb
 |  |- B.rb
 |
 |-conf            ←設定ファイル配置場所
 |  |- A.yaml      ←個別設定ファイル
 |  |- B.yaml
 |  |- common.yaml  ←共通設定ファイル
 |
 |-log             ←ログ出力場所
 |  |- YYYYMMDD_HHMMSS_A.log
 |  |- YYYYMMDD_HHMMSS_B.log
 |
 |-lib             ←ライブラリ配置場所
     |-  lib_X.rb
     |-  lib_Y.rb
</code></pre>

<h3>自動ログ出力</h3>

<p>ログブロックを使うことで、自動的にログファイルに出力することができます。
ログファイルはデフォルトで<code>${RB_HOME}/log/YYYYMMDD_HHMMSS_(スクリプトのbasename).log</code>に出力されます。
ログブロック内で発生した例外をキャッチし、ログにスタックトレースを出力することができます。</p>

<p>サンプル</p>

<p>スクリプト<code>${RB_HOME}/bin/sample1.rb</code> を作ります</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rbatch</span><span class='tstring_end'>'</span></span>

<span class='const'>RBatch</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_log'>log</span><span class='op'>|</span>  <span class='comment'># ログブロック
</span>  <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>info string</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error string</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exception</span><span class='tstring_end'>&quot;</span></span>
<span class='rbrace'>}</span>
</code></pre>

<p>実行するとログファイル<code>${RB_HOME}/log/20121020_005953_sample1.log</code>が以下のように出力されます</p>

<pre class="code ruby"><code class="ruby"># Logfile created on 2012-10-20 00:59:53 +0900 by logger.rb/25413
[2012-10-20 00:59:53 +900] [INFO ] info string
[2012-10-20 00:59:53 +900] [ERROR] error string
[2012-10-20 00:59:53 +900] [FATAL] Caught exception; existing 1
[2012-10-20 00:59:53 +900] [FATAL] exception (RuntimeError)
    [backtrace] test.rb:6:in `block in &lt;main&gt;'
    [backtrace] /usr/local/lib/ruby192/lib/ruby/gems/1.9.1/gems/rbatch-1.0.0/lib/rbatch/auto_logger.rb:37:in `initialize'
    [backtrace] test.rb:3:in `new'
    [backtrace] test.rb:3:in `&lt;main&gt;'
</code></pre>

<h3>自動ライブラリ読み込み</h3>

<p><code>${RB_HOME}/lib/*.rb</code>にライブラリファイルを配置すると、スクリプトが起動する前に自動的に読み込まれます。</p>

<h3>自動メール送信</h3>

<p><code>log_send_mail</code>オプションを使う事により、スクリプトでエラーが発生した場合に、自動でメールを送信することができます。</p>

<h3>自動設定ファイル読み込み</h3>

<p>RBatchは簡単にデフォルトの位置の設定ファイルを読み込めます。
デフォルトの位置は<code>${RB_HOME}/conf/(プログラムbasename).yaml</code>です。</p>

<p>サンプル</p>

<p>設定ファイル <code>${RB_HOME}/conf/sample2.yaml</code> を作ります</p>

<pre class="code ruby"><code class="ruby">key: value
array:
 - item1
 - item2
 - item3
</code></pre>

<p>スクリプト<code>${RB_HOME}/bin/sample2.rb</code>で、以下のように設定値を呼び出すことができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rbatch</span><span class='tstring_end'>'</span></span>

<span class='comment'># 設定ファイルのロードなど無しにいきなり設定値を利用できます
</span><span class='id identifier rubyid_p'>p</span> <span class='const'>RBatch</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>    <span class='comment'># =&gt; &quot;value&quot;
</span><span class='id identifier rubyid_p'>p</span> <span class='const'>RBatch</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>array</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>  <span class='comment'># =&gt; [&quot;item1&quot;, &quot;item2&quot;, &quot;item3&quot;]
</span>
<span class='comment'># もしキーが存在しない場合は自動的に例外が発生します
</span><span class='id identifier rubyid_p'>p</span> <span class='const'>RBatch</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>not_exist</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='comment'># =&gt; RBatch::ConfigExceptionが発生
</span></code></pre>

<h4>共通設定ファイル</h4>

<p>すべてのスクリプトから共通で読み込む設定ファイルを作りたい場合は、<code>${RB_HOME}/conf/common.yaml</code>というファイルを作ることで可能です。</p>

<h3>外部コマンド実行</h3>

<p>RBatchは外部コマンド（たとえば&quot;ls -l&quot;）を実行するラッパー関数を提供します。</p>

<p>この関数は、実行結果をオブジェクトで返し、そのオブジェクトは標準出力、標準エラー出力、およびexitステータスを含みます。</p>

<p>サンプル</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rbatch</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_r'>r</span> <span class='op'>=</span> <span class='const'>RBatch</span><span class='period'>.</span><span class='id identifier rubyid_cmd'>cmd</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ls</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_stdout'>stdout</span> <span class='comment'># =&gt; &quot;fileA\nfileB\n&quot;
</span><span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_stderr'>stderr</span> <span class='comment'># =&gt; &quot;&quot;
</span><span class='id identifier rubyid_p'>p</span> <span class='id identifier rubyid_r'>r</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='comment'># =&gt; 0
</span></code></pre>

<p>外部コマンドにタイムアウトを設定したい場合は<code>cmd_timeout</code>をオプションを利用できます。</p>

<p><code>cmd_raise</code>オプションを利用することにより、コマンドの戻り値が0以外の場合、例外を発生させることができます。これによりエラーハンドリングのロジックを省略できます。</p>

<h3>二重起動チェック</h3>

<p><code>forbid_double_run</code>のオプションを利用すれば、RBatchを利用したプログラムの二重起動チェックができます。</p>

<h2>ドキュメント</h2>

<p>こちらにあります→ <a href="http://fetaro.github.io/rbatch/index.html">Document (YardDoc)</a></p>

<h2>サンプル</h2>

<h3>AWS EC2 のボリュームバックアップスクリプト</h3>

<p>最初に以下の設定ファイルを作ります</p>

<p>設定ファイル : <code>${RB_HOME}/conf/ec2_create_snapshot.yaml</code></p>

<pre class="code ruby"><code class="ruby">access_key : AKIAITHEXXXXXXXXX
secret_key : JoqJSdP8+tpdFYWljVbG0+XXXXXXXXXXXXXXX

</code></pre>

<p>次に、スクリプトを書きます。</p>

<p>スクリプト : <code>${RB_HOME}/bin/ec2_create_snapshot.rb</code></p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rbatch</span><span class='tstring_end'>'</span></span>  <span class='comment'># &lt;= rbatchをrequireします
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>aws-sdk</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>net/http</span><span class='tstring_end'>'</span></span>

<span class='const'>RBatch</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_log'>log</span><span class='op'>|</span> <span class='comment'># &lt;= ログブロックを開始し、スクリプトはこの中に入れます
</span>  <span class='comment'># get ec2 region
</span>  <span class='ivar'>@ec2_region</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ec2.</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>169.254.169.254</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/latest/meta-data/placement/availability-zone</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_chop'>chop</span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.amazonaws.com</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ec2 region : </span><span class='embexpr_beg'>#{</span><span class='ivar'>@ec2_region</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='comment'># &lt;= このようにログを出力できます
</span>
  <span class='comment'>#create ec2 instance
</span>  <span class='ivar'>@ec2</span> <span class='op'>=</span> <span class='const'>AWS</span><span class='op'>::</span><span class='const'>EC2</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='symbol'>:access_key_id</span>     <span class='op'>=&gt;</span> <span class='const'>RBatch</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>access_key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>  <span class='comment'># &lt;= 設定ファイルを読み込みます
</span>                      <span class='symbol'>:secret_access_key</span> <span class='op'>=&gt;</span> <span class='const'>RBatch</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>secret_key</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
                      <span class='symbol'>:ec2_endpoint</span>      <span class='op'>=&gt;</span> <span class='ivar'>@ec2_region</span><span class='rparen'>)</span>


  <span class='comment'># create instance
</span>  <span class='ivar'>@instance_id</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>169.254.169.254</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/latest/meta-data/instance-id</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='ivar'>@instance</span> <span class='op'>=</span> <span class='ivar'>@ec2</span><span class='period'>.</span><span class='id identifier rubyid_instances'>instances</span><span class='lbracket'>[</span><span class='ivar'>@instance_id</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>instance_id : </span><span class='embexpr_beg'>#{</span><span class='ivar'>@instance_id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

  <span class='comment'># create snapshots
</span>  <span class='ivar'>@instance</span><span class='period'>.</span><span class='id identifier rubyid_block_devices'>block_devices</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span> <span class='id identifier rubyid_dev'>dev</span> <span class='op'>|</span>
    <span class='id identifier rubyid_desc'>desc</span> <span class='op'>=</span> <span class='ivar'>@instance_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_dev'>dev</span><span class='lbracket'>[</span><span class='symbol'>:device_name</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
      <span class='id identifier rubyid_dev'>dev</span><span class='lbracket'>[</span><span class='symbol'>:ebs</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:volume_id</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%Y/%m/%d %H:%M</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>create snapshot : </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_desc'>desc</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='ivar'>@ec2</span><span class='period'>.</span><span class='id identifier rubyid_volumes'>volumes</span><span class='lbracket'>[</span><span class='id identifier rubyid_dev'>dev</span><span class='lbracket'>[</span><span class='symbol'>:ebs</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:volume_id</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_create_snapshot'>create_snapshot</span><span class='lparen'>(</span><span class='id identifier rubyid_desc'>desc</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_log'>log</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sucess</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

</code></pre>

<p>最後にスクリプトを実行すると、以下のようなログが出力されます</p>

<p>ログファイル : <code>${RB_HOME}/log/20140121_123124_ec2_create_snapshot.log</code></p>

<pre class="code ruby"><code class="ruby">[2014-01-21 12:31:24 -0500] [INFO ] === START RBatch === (PID=10095)
[2014-01-21 12:31:24 -0500] [INFO ] RB_HOME : &quot;/opt/MyProject&quot;
[2014-01-21 12:31:24 -0500] [INFO ] Load Run-Conf: &quot;/opt/MyProject/.rbatchrc&quot;
[2014-01-21 12:31:24 -0500] [INFO ] Load Config  : &quot;/opt/MyProject/conf/ec2_create_snapshot.yaml&quot;
[2014-01-21 12:31:24 -0500] [INFO ] Start Script : &quot;/opt/MyProject/bin/ec2_create_snapshot.rb&quot;
[2014-01-21 12:31:24 -0500] [INFO ] Logging Start: &quot;/opt/MyProject/log/20140121_123124_ec2_create_snapshot.log&quot;
[2014-01-21 12:31:24 -0500] [INFO ] ec2 region : ec2.ap-northeast-1.amazonaws.com
[2014-01-21 12:31:25 -0500] [INFO ] instance_id : i-cc25f1c9
[2014-01-21 12:31:25 -0500] [INFO ] create snapshot : i-cc25f1c9 /dev/sda1 vol-82483ea7 2014/01/21 12:31
[2014-01-21 12:31:25 -0500] [INFO ] sucess
</code></pre>

<p>これだけで、ログ出力と設定ファイル読み込みを兼ね備えたスクリプトを作成することができます。</p>

<h2>カスタマイズ</h2>

<p>RBatchではオプションの指定の仕方は以下の二つがあります。</p>

<ul>
<li>(1) Run-Conf(<code>${RB_HOME}/.rbatchrc</code>)に書く</li>
<li>(2) スクリプト内でオプションオブジェクトをコンストラクタの引数に渡す</li>
</ul>

<p>同じオプションを(1)と(2)の両方で指定すると、(2)が優先されます。</p>

<h3>Run-Conf(.rbatchrc)によるカスタマイズ</h3>

<p>Run-Conf(<code>${RB_HOME}/.rbatchrc</code>)のサンプルは以下の通り</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># RBatch Run-Conf (.rbatchrc)
</span><span class='comment'>#
</span><span class='comment'>#   設定ファイルの形式はYAML形式です
</span><span class='comment'>#
</span>
<span class='comment'># -------------------
</span><span class='comment'># 全体
</span><span class='comment'># -------------------
</span>
<span class='comment'># 設定ファイルディレクトリ
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトは &quot;&lt;home&gt;/conf&quot;
</span><span class='comment'>#   &lt;home&gt; は ${RB_HOME} に置き換わります
</span><span class='comment'>#
</span><span class='comment'>#conf_dir : &lt;home&gt;/config
</span><span class='comment'>#conf_dir : /etc/rbatch/
</span>
<span class='comment'># スクリプト間共通設定ファイル名
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトは&quot;common.yaml&quot;
</span><span class='comment'>#
</span><span class='comment'>#common_conf_name: share.yaml
</span>
<span class='comment'># ライブラリディレクトリ
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトは&quot;&lt;home&gt;/lib&quot;
</span><span class='comment'>#   &lt;home&gt; は${RB_HOME}に置き換わります
</span><span class='comment'>#
</span><span class='comment'>#lib_dir : /usr/local/lib/rbatch/
</span>
<span class='comment'># 自動ライブラリ読み込み
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトはtrue
</span><span class='comment'>#   trueの場合、スクリプトが始まる前に&quot;(ライブラリディレクトリ)/*.rb&quot;をrequireします
</span><span class='comment'>#
</span><span class='comment'>#auto_lib_load : true
</span><span class='comment'>#auto_lib_load : false
</span>
<span class='comment'># スクリプトの二重起動を可能にするかどうか
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値はfalse。
</span><span class='comment'>#   trueにすると、同じ名前のスクリプトは二つ同時に起動できなくなります。
</span><span class='comment'>#
</span><span class='comment'>#forbid_double_run : true
</span><span class='comment'>#forbid_double_run : false
</span>
<span class='comment'># RBatchジャーナルのLevel
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトは1
</span><span class='comment'>#   RBatchジャーナルはRBatch自体の実行ログであり、[RBatch] の接頭辞が
</span><span class='comment'>#   付くメッセージである。通常は標準出力に出力される
</span><span class='comment'>#   大きい数を指定すると多くのジャーナルが出力される。
</span><span class='comment'>#   0を指定すると何も表示されない。
</span><span class='comment'>#
</span><span class='comment'>#   RBatchジャーナルの例
</span><span class='comment'>#     [RBatch] === START RBatch === (PID=5795)
</span><span class='comment'>#     [RBatch] RB_HOME : &quot;/path/to/&quot;
</span><span class='comment'>#     [RBatch] Load Run-Conf: &quot;/path/to/.rbatchrc&quot;
</span><span class='comment'>#     [RBatch] Start Script : &quot;/path/to/bin/hello.rb&quot;
</span><span class='comment'>#     ....
</span><span class='comment'>#
</span><span class='comment'>#rbatch_journal_level : 2
</span><span class='comment'>#rbatch_journal_level : 0
</span>
<span class='comment'># RBatchジャーナルをログに混ぜ込む
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトは true。
</span><span class='comment'>#   trueを指定すると、RBatchジャーナルを標準出力だけでなく
</span><span class='comment'>#   その時開かれているログにも出力する。
</span><span class='comment'>#
</span><span class='comment'>#mix_rbatch_journal_to_logs : true
</span><span class='comment'>#mix_rbatch_journal_to_logs : false
</span>
<span class='comment'># -------------------
</span><span class='comment'># ログ関連
</span><span class='comment'># -------------------
</span>
<span class='comment'># ログディレクトリ
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトは &quot;&lt;home&gt;/log&quot;
</span><span class='comment'>#   &lt;home&gt; は ${RB_HOME} に置き換わります
</span><span class='comment'>#
</span><span class='comment'>#log_dir : &lt;home&gt;/rb_log
</span><span class='comment'>#log_dir : /var/log/rbatch/
</span>
<span class='comment'># ログファイル名
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値は&quot;&lt;date&gt;_&lt;time&gt;_&lt;prog&gt;.log&quot;。
</span><span class='comment'>#   &lt;data&gt; はYYYYMMDDの日付形式に置換されます
</span><span class='comment'>#   &lt;time&gt; はhhmmssの時刻形式に置換されます
</span><span class='comment'>#   &lt;prog&gt; は拡張子を除いたファイル名に置換されます
</span><span class='comment'>#   &lt;host&gt; はホスト名に置換されます
</span><span class='comment'>#
</span><span class='comment'>#log_name : &quot;&lt;date&gt;_&lt;time&gt;_&lt;prog&gt;.log&quot;
</span><span class='comment'>#log_name : &quot;&lt;date&gt;_&lt;prog&gt;.log&quot;
</span>
<span class='comment'># ログを追記するかどうか
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値はture。
</span><span class='comment'>#
</span><span class='comment'>#log_append : true
</span><span class='comment'>#log_append : false
</span>
<span class='comment'># ログレベル
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値は&quot;info&quot;。
</span><span class='comment'>#   設定できる値は&quot;debug&quot;,&quot;info&quot;,&quot;wran&quot;,&quot;error&quot;,&quot;fatal&quot;。
</span><span class='comment'>#
</span><span class='comment'>#log_level : &quot;debug&quot;
</span><span class='comment'>#log_level : &quot;warn&quot;
</span>
<span class='comment'># 標準出力とログの両方に文字列を出力するかどうか
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値はfalse。
</span><span class='comment'>#
</span><span class='comment'>#log_stdout : true
</span><span class='comment'>#log_stdout : false
</span>
<span class='comment'># 古いログを削除するかどうか
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値はfalse。
</span><span class='comment'>#   trueの場合、RBatch::Log.newを呼んだタイミングで、古いログを削除する。
</span><span class='comment'>#   削除対象のログは、そのRBatch::Logのインスタンスが出力するログファイルと
</span><span class='comment'>#   同じファイル名フォーマットであり、かつログファイル名のフォーマットに&lt;date&gt;が
</span><span class='comment'>#   含まれるもの。
</span><span class='comment'>#
</span><span class='comment'>#log_delete_old_log : true
</span><span class='comment'>#log_delete_old_log : false
</span>
<span class='comment'># 古いログの残す日数
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値は 7
</span><span class='comment'>#
</span><span class='comment'>#log_delete_old_log_date : 14
</span>
<span class='comment'># ログのバッファリング
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値はfalse。
</span><span class='comment'>#   trueにするとログへの出力をバッファリングする。
</span><span class='comment'>#
</span><span class='comment'>#log_bufferd : true
</span><span class='comment'>#log_bufferd : false
</span>
<span class='comment'># exitステータスをログに出すかどうか 
</span><span class='comment'>#
</span><span class='comment'>#   デフォルトはtrue。
</span><span class='comment'>#   ログブロック内で &quot;exist&quot; メソッドを使った時に、
</span><span class='comment'>#   exitステータスをログファイルに出力する。
</span><span class='comment'>#
</span><span class='comment'>#log_output_exit_status : true
</span><span class='comment'>#log_output_exit_status : false
</span>
<span class='comment'># メール送信するかどうか
</span><span class='comment'># 
</span><span class='comment'>#   デフォルト値は false。
</span><span class='comment'>#   log.error(msg)かlog.fatal(msg) を呼び出したときに,&quot;msg&quot;の内容をメールで送信する。
</span><span class='comment'>#
</span><span class='comment'>#log_send_mail : true
</span>
<span class='comment'># メール送信のパラメータ
</span><span class='comment'>#
</span><span class='comment'>#log_mail_to   : &quot;xxx@sample.com&quot;
</span><span class='comment'>#log_mail_from : &quot;xxx@sample.com&quot;
</span><span class='comment'>#log_mail_server_host : &quot;localhost&quot;
</span><span class='comment'>#log_mail_server_port : 25
</span><span class='comment'>#
</span><span class='comment'># 宛先を複数指定した場合は配列を利用する
</span><span class='comment'>#
</span><span class='comment'>#log_mail_to :
</span><span class='comment'>#  - &quot;AAA@sample.com&quot;
</span><span class='comment'>#  - &quot;BBB@sample.com&quot;
</span>

<span class='comment'># -------------------
</span><span class='comment'># 外部コマンド実行関連
</span><span class='comment'># -------------------
</span>
<span class='comment'># 例外発生機能を有効にするかどうか
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値はfalse。
</span><span class='comment'>#   trueの場合、コマンドの終了ステータスが0でない場合に例外を発生する。
</span><span class='comment'>#
</span><span class='comment'>#cmd_raise : true
</span><span class='comment'>#cmd_raise : false
</span>
<span class='comment'># 外部コマンドのタイムアウト
</span><span class='comment'>#
</span><span class='comment'>#   デフォルト値は0[sec]。
</span><span class='comment'>#
</span><span class='comment'>#cmd_timeout : 5
</span>

</code></pre>

<h3>コンストラクタの引数によるオプション指定</h3>

<p>スクリプト内で一時的にオプションを指定したい場合は、RBatch::LogクラスもしくはRBatch::Cmdクラスのコンストラクタの引数にオプションのハッシュを指定します。</p>

<h4>RBatch::Logクラスのオプション</h4>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='symbol'>:name</span>      <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;date&gt;_&lt;time&gt;_&lt;prog&gt;.log</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='symbol'>:dir</span>       <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/var/log/</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='symbol'>:append</span>    <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
      <span class='symbol'>:level</span>     <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>info</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='symbol'>:stdout</span>    <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
      <span class='symbol'>:delete_old_log</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
      <span class='symbol'>:delete_old_log_date</span> <span class='op'>=&gt;</span> <span class='int'>7</span><span class='comma'>,</span>
      <span class='symbol'>:bufferd</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
      <span class='symbol'>:log_output_exit_status</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
      <span class='symbol'>:send_mail</span> <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
      <span class='symbol'>:mail_to</span>   <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span>
      <span class='symbol'>:mail_from</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rbatch.localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='symbol'>:mail_server_host</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>localhost</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
      <span class='symbol'>:mail_server_port</span> <span class='op'>=&gt;</span> <span class='int'>25</span>
<span class='rbrace'>}</span>

<span class='const'>RBatch</span><span class='op'>::</span><span class='const'>Log</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span>
</code></pre>

<h4>RBatch::Cmdクラスのオプション</h4>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='symbol'>:raise</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
      <span class='symbol'>:timeout</span>   <span class='op'>=&gt;</span> <span class='int'>0</span>
<span class='rbrace'>}</span>

<span class='const'>RBatch</span><span class='op'>::</span><span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd_str'>cmd_str</span><span class='comma'>,</span> <span class='id identifier rubyid_opt'>opt</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span>
</code></pre>

<h2>version 1 から 2 へのマイグレーション</h2>

<p><code>${RB_HOME}/conf/rbatch.yaml</code> を <code>${RB_HOME}/.rbatchrc</code> に移動してください。</p>
</div></div>

    <div id="footer">
  Generated on Mon Jun  8 17:04:15 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.3 (ruby-1.9.2).
</div>

  </body>
</html>